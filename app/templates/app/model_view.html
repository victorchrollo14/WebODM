{% extends "app/logged_in_base.html" %}

{% block headers-before-bundle %}
    <link rel="stylesheet" type="text/css" href="/static/app/js/vendor/potree/build/potree/potree.css">
    <link rel="stylesheet" type="text/css" href="/static/app/js/vendor/potree/libs/jquery-ui/jquery-ui.min.css">
    <link rel="stylesheet" type="text/css" href="/static/app/js/vendor/potree/libs/openlayers3/ol.css">
    <link rel="stylesheet" type="text/css" href="/static/app/js/vendor/potree/libs/spectrum/spectrum.css">
    <link rel="stylesheet" type="text/css" href="/static/app/js/vendor/potree/libs/jstree/themes/mixed/style.css">

    <script src="/static/app/js/vendor/potree/libs/spectrum/spectrum.js"></script>
    <script src="/static/app/js/vendor/potree/libs/jquery-ui/jquery-ui.min.js"></script>
    <script src="/static/app/js/vendor/potree/libs/three.js/build/three.min.js"></script>
    <script src="/static/app/js/vendor/potree/libs/three.js/extra/lines.js"></script>
    <script src="/static/app/js/vendor/potree/libs/other/BinaryHeap.js"></script>
    <script src="/static/app/js/vendor/potree/libs/tween/tween.min.js"></script>
    <script src="/static/app/js/vendor/potree/libs/d3/d3.js"></script>
    <script src="/static/app/js/vendor/potree/libs/proj4/proj4.js"></script>
    <script src="/static/app/js/vendor/potree/libs/openlayers3/ol.js"></script>
    <script src="/static/app/js/vendor/potree/libs/i18next/i18next.js"></script>
    <script src="/static/app/js/vendor/potree/libs/jstree/jstree.js"></script>
    <script src="/static/app/js/vendor/potree/build/potree/potree.js"></script>
    <script src="/static/app/js/vendor/potree/libs/plasio/js/laslaz.js"></script>
    <script type="module" src="/static/app/js/vendor/GLTFLoader.js"></script>
    <script type="module" src="/static/app/js/vendor/OBJLoader.js"></script>
    <script type="module" src="/static/app/js/vendor/DRACOLoader.js"></script>
{% endblock %}


{% block content %}
<div class='model-section'>
  <h1>{{model_name}}</h1>
<div class="potree_container full-height" style="position:relative; width: 100%; height: 100%; min-height:787px; left: 0px; top: 0px; ">	
    <div id="potree_render_area" ></div>
		<div id="potree_sidebar_container" > </div>
</div>
</div>
<script type="module">
  /* const form = document.querySelector(".form");
   form.addEventListener("submit", uploadModal);

   function uploadModal(e) {
    e.preventDefault();
    console.log("hi");

    const formData = new FormData(form);
    const file = formData.get("upload");
    console.log(file);
  } */

//  import * as THREE from  "../../static/app/js/vendor/potree/libs/three.js/build/three.min.js"
//  import {GLTFLoader} from '../../static/app/js/vendor/GLTFLoader.js' 

  window.viewer = new Potree.Viewer(document.getElementById('potree_render_area'));
  
  viewer.setEDLEnabled(true);
  viewer.setFOV(60);
  viewer.setPointBudget(1 * 1000 * 1000);
  viewer.loadSettingsFromURL();
  
  viewer.loadGUI(() => {
     viewer.setLanguage('en');
     $('#menu-appearance').next().show();
     $('#menu_tools').next().show();
     $('#menu_scene').next().show();
     viewer.toggleSidebar();
  });

  
  viewer.scene.scene.add(new window.THREE.AmbientLight(0x404040, 2.0)); // soft white light );
  viewer.scene.scene.add(new window.THREE.DirectionalLight(0xcccccc, 0.5));
 
  const THREE = window.THREE;
  const GLTFLoader = window.THREE.GLTFLoader; 
  const DRACOLoader = window.THREE.DRACOLoader;
  
  const gltfLoader = new GLTFLoader(); 
  const dracoLoader = new DRACOLoader();
  dracoLoader.setDecoderPath("/static/app/js/vendor/draco/");
  gltfLoader.setDRACOLoader(dracoLoader);

  const fileUrl = "{{file_url}}"
  
  gltfLoader.load(fileUrl, (gltf) => {
    
    console.log(gltf);
    const offset = { x: 0, y: 0 };
    if (gltf.scene.CESIUM_RTC && gltf.scene.CESIUM_RTC.center) {
          offset.x = gltf.scene.CESIUM_RTC.center[0];
          offset.y = gltf.scene.CESIUM_RTC.center[1];
     }

     gltf.scene.translateX(offset.x);
     gltf.scene.translateY(offset.y);

     viewer.scene.scene.add(gltf.scene);
  })  

</script>
{% endblock %}
